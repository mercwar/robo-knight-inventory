name: FIRE-CYHY-MERC-G-PORTAL-EXPANDED

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  portal-orchestration:
    runs-on: ubuntu-latest
    container: debian:bookworm
    permissions:
      contents: write

    steps:
      - name: Checkout & Pulse Init
        uses: actions/checkout@v4

      - name: Hardcode Portal State
        run: |
          touch fire-portal.log
          echo "[$(date)] SYSTEM: Debian Core Booted. Registry Locked." >> fire-portal.log

      - name: Kernel & AI Dependency Lock
        run: |
          apt-get update && apt-get install -y \
            nasm gcc g++ binutils jq git curl \
            python3 python3-pip python3-torch \
            linux-headers-amd64
          python3 -m pip install tensorflow opencv-python --break-system-packages

      - name: Multi-Phase ASM Compilation
        run: |
          echo "[$(date)] JOB: Compiling Portal Suite..." >> fire-portal.log
          # Compile the Logger and Finalizer first so they are available to Gem
          nasm -f elf64 fire-log.asm -o fire-log.o && ld fire-log.o -o fire-log_bin
          nasm -f elf64 fire-end.asm -o fire-end.o && ld fire-end.o -o fire-end_bin
          # Compile the Master Dispatcher
          nasm -f elf64 fire-gem.asm -o fire-gem.o && ld fire-gem.o -o fire-gem_bin
          echo "[$(date)] JOB: Binaries Linked. Launching Gem Dispatcher." >> fire-portal.log
          ./fire-gem_bin >> fire-portal.log 2>&1
