name: FIRE-CYHY-MERC-G-PORTAL

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  portal-orchestration:
    runs-on: ubuntu-latest
    container: debian:bookworm # Native Debian Environment
    permissions:
      contents: write

    steps:
      # 1️⃣ Pull Repo & Initialize Log Immediately
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize Portal Log
        run: |
          touch fire-portal.log
          echo "[$(date)] SYSTEM: Repo Pulled. Debian Core Active." >> fire-portal.log

      # 2️⃣ Install Core Debian & Kernel Development Packages
      - name: Install System Dependencies
        run: |
          echo "[$(date)] JOB: Package Installation Started" >> fire-portal.log
          apt-get update && apt-get install -y \
            nasm gcc g++ binutils build-essential \
            python3 python3-pip python3-torch \
            php apache2 curl git jq \
            linux-headers-amd64 # Core Debian Kernel Headers
          
          # Install AI Libraries via pip (Debian compliant)
          python3 -m pip install --upgrade pip --break-system-packages
          pip install tensorflow opencv-python --break-system-packages
          echo "[$(date)] JOB: Dependencies Installed Successfully" >> fire-portal.log

      # 3️⃣ Immediate NASM Compilation of fire-gem
      - name: Compile and Run FIRE-GEM
        run: |
          echo "[$(date)] JOB: Compiling fire-gem.asm" >> fire-portal.log
          chmod +x *.sh
          
          # Assemble and Link elf64
          nasm -f elf64 fire-gem.asm -o fire-gem.o
          ld fire-gem.o -o fire-gem_bin
          
          echo "[$(date)] JOB: Executing fire-gem_bin" >> fire-portal.log
          ./fire-gem_bin >> fire-portal.log 2>&1
          # fire-gem_bin executes internal logic, calling fire-end.asm to push.

      # 4️⃣ Record and Stage Updates (Pushing handled by fire-end.asm)
      - name: Archive Job Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: portal-execution-logs
          path: fire-portal.log
